<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WishHub - Минимальный вишлист</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo-title">
    <img src="{{ url_for('static', filename='img/wishhub.png') }}" alt="WishHub logo" class="logo">
    WishHub
</h1>
            <p class="subtitle">Создайте вишлист за минуту вручную</p>
            <p class="subtitle subtitle-link">
    <a href="https://t.me/Wishhub_ru" target="_blank">
        <i class="fab fa-telegram"></i> Наш Telegram канал, в котором есть различные вариации подборок подарков, где вы обязательно найдете что-то для своего вишлиста!
    </a>
</p>
        </header>

        {% if editable %}
        <div class="input-section">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('manual')">
                    <i class="fas fa-edit"></i> Ручное добавление
                </button>
            </div>

            <!-- Ручное добавление -->
            <div id="tab-manual" class="tab-content active">
                <div class="input-group">
                    <input type="text" id="manual-name" placeholder="Название товара*">
                </div>
                <div class="input-group">
                    <input type="text" id="manual-price" placeholder="Цена*">
                </div>
                <div class="input-group">
                    <input type="text" id="manual-image" placeholder="Ссылка на изображение">
                </div>
                <div class="input-group">
                    <input type="text" id="manual-url" placeholder="Ссылка на товар">
                </div>
                <div class="input-group">
                    <textarea id="manual-description" rows="3" placeholder="Описание"></textarea>
                </div>
                <button class="btn btn-primary" id="add-manual-btn">
                    <i class="fas fa-plus"></i> Добавить в список
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Таблица с товарами -->
        <div class="table-section">
            <div class="wishlist-header-row">
                <h2>
                    <i class="fas fa-list"></i> {{ wishlist.name }}
                    <span id="item-count">(0 товаров)</span>
                </h2>
                
                {% if editable %}
                <button class="btn btn-share-header" onclick="showShareModal()">
                    <i class="fas fa-share-alt"></i> Поделиться вишлистом
                </button>
                {% endif %}
            </div>

            <div id="empty-state" class="empty-state" {% if items %}style="display:none"{% endif %}>
                <i class="fas fa-box-open"></i>
                <h3>Список пуст</h3>
                <p>Добавьте первый товар с помощью формы выше</p>
            </div>

            <table id="wishlist-table" {% if not items %}style="display:none"{% endif %}>
                <thead>
                    <tr>
                        <th class="col-image">Изображение</th>
                        <th class="col-name">Товар</th>
                        <th class="col-price">Цена</th>
                        <th class="col-date">Добавлено</th>
                        <th class="col-actions">Действия</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for item in items %}
                    <tr id="item-{{ item.id }}">
                        <td>
                            {% if item.image %}
                            <img src="{{ item.image }}" alt="{{ item.name }}" class="item-image">
                            {% else %}
                            <div class="item-image placeholder">
                                <i class="fas fa-gift"></i>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="item-name">{{ item.name }}</div>
                            {% if item.description %}
                            <div class="item-description">{{ item.description }}</div>
                            {% endif %}
                            {% if item.source_url %}
                            <div class="item-link">
                                <a href="{{ item.source_url }}" target="_blank">
                                    <i class="fas fa-external-link-alt"></i> Ссылка на товар
                                </a>
                            </div>
                            {% endif %}
                            <div class="item-status">
                                <span class="status-badge status-manual">Вручную</span>
                            </div>
                        </td>
                        <td>{{ item.price }}</td>
                        <td>{{ item.added_date }}</td>
                        <td>
                            {% if editable %}
                            <div class="item-actions">
                                <button class="btn btn-danger" onclick="deleteItem({{ item.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>WishHub MVP • Данные хранятся в памяти • 
                {% if editable %}<a href="#" onclick="clearAll()" class="clear-link">Очистить весь список</a>{% endif %}
            </p>
        </footer>
    </div>

    <!-- Модальное окно для шаринга -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-share-alt"></i> Поделиться вишлистом</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="wishlist-name-container">
                    <h3 id="modalWishlistName">{{ wishlist.name }}</h3>
                </div>
                
                <div class="link-options">
                    <div class="link-option">
                        <div class="option-header">
                            <div class="option-icon view-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="option-info">
                                <h4>Только просмотр</h4>
                                <p>Друзья смогут только смотреть список, но не редактировать его</p>
                            </div>
                        </div>
                        <div class="option-input-group">
                            <input type="text" id="viewLink" readonly class="link-input-large">
                            <button class="btn btn-copy" data-clipboard-target="#viewLink">
                                <i class="fas fa-copy"></i> Копировать
                            </button>
                        </div>
                        <div class="option-share-buttons">
                            <button class="btn btn-share whatsapp" data-type="view">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn btn-share telegram" data-type="view">
                                <i class="fab fa-telegram"></i> Telegram
                            </button>
                            <button class="btn btn-share email" data-type="view">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                        </div>
                    </div>
                    
                    <div class="divider">
                        <span>или</span>
                    </div>
                    
                    <div class="link-option">
                        <div class="option-header">
                            <div class="option-icon edit-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="option-info">
                                <h4>Полный доступ</h4>
                                <p>Позволяет редактировать список. Делитесь только с доверенными лицами!</p>
                            </div>
                        </div>
                        <div class="option-input-group">
                            <input type="text" id="editLink" readonly class="link-input-large">
                            <button class="btn btn-copy" data-clipboard-target="#editLink">
                                <i class="fas fa-copy"></i> Копировать
                            </button>
                        </div>
                        <div class="option-share-buttons">
                            <button class="btn btn-share whatsapp" data-type="edit">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn btn-share telegram" data-type="edit">
                                <i class="fab fa-telegram"></i> Telegram
                            </button>
                            <button class="btn btn-share email" data-type="edit">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                        </div>
                        <div class="security-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Внимание: Эта ссылка дает полный доступ к редактированию списка!</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-hint">
                    <i class="fas fa-lightbulb"></i>
                    <p>Скопируйте нужную ссылку или поделитесь напрямую через мессенджер</p>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

<script>
    const editable = {{ editable | tojson }};
</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        updateItemCount();
        
        // Устанавливаем ссылки для модального окна
        const baseUrl = window.location.origin;
        const wishlistId = {{ wishlist.id }};
        
        // Публичная ссылка для просмотра
        document.getElementById('viewLink').value = `${baseUrl}/wishlist/${wishlistId}`;
        
        // Приватная ссылка для редактирования (только если мы в режиме редактирования)
        if (editable) {
            const currentUrl = new URL(window.location.href);
            const key = currentUrl.searchParams.get('key');
            if (key) {
                document.getElementById('editLink').value = `${baseUrl}/wishlist/${wishlistId}/edit?key=${key}`;
            }
        }
        
        // Настройка модального окна
        const modal = document.getElementById('shareModal');
        const closeBtn = document.querySelector('.modal-close');
        
        // Закрытие модалки по клику на крестик
        closeBtn.addEventListener('click', function() {
            modal.classList.remove('active');
        });
        
        // Закрытие модалки по клику вне ее
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
        
        // Копирование ссылок
        document.querySelectorAll('.btn-copy').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.dataset.clipboardTarget;
                const input = document.querySelector(targetId);
                
                input.select();
                input.setSelectionRange(0, 99999); // Для мобильных
                
                try {
                    navigator.clipboard.writeText(input.value).then(() => {
                        showNotification('Ссылка скопирована в буфер обмена!', 'success');
                    });
                } catch (err) {
                    // Fallback для старых браузеров
                    document.execCommand('copy');
                    showNotification('Ссылка скопирована!', 'success');
                }
                
                // Визуальный feedback
                this.innerHTML = '<i class="fas fa-check"></i> Скопировано';
                this.style.background = '#4CAF50';
                
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i> Копировать';
                    this.style.background = '';
                }, 2000);
            });
        });
        
        // Шаринг через мессенджеры
        document.querySelectorAll('.btn-share').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                const link = type === 'view' 
                    ? document.getElementById('viewLink').value
                    : document.getElementById('editLink').value;
                const wishlistName = document.getElementById('modalWishlistName').textContent;
                
                const text = `Посмотри мой вишлист "${wishlistName}": ${link}`;
                const encodedText = encodeURIComponent(text);
                
                let shareUrl;
                switch(this.classList[2]) {
                    case 'whatsapp':
                        shareUrl = `https://wa.me/?text=${encodedText}`;
                        break;
                    case 'telegram':
                        shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(`Посмотри мой вишлист "${wishlistName}"`)}`;
                        break;
                    case 'email':
                        shareUrl = `mailto:?subject=Мой вишлист: ${encodeURIComponent(wishlistName)}&body=${encodedText}`;
                        break;
                }
                
                window.open(shareUrl, '_blank');
            });
        });
        
        // Закрытие по Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                modal.classList.remove('active');
            }
        });
    });
    
    // Функция показа модального окна
    function showShareModal() {
        const modal = document.getElementById('shareModal');
        modal.classList.add('active');
        
        // Блокируем прокрутку фона
        document.body.style.overflow = 'hidden';
    }
    
    // Функция показа уведомлений
    function showNotification(msg, type = 'success') {
        const n = document.getElementById('notification');
        n.textContent = msg;
        n.className = `notification ${type} show`;
        setTimeout(() => n.classList.remove('show'), 3000);
    }
</script>
</body>
</html>